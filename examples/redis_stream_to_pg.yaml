#
# read entries from a redis stream named 'emp'
#
- uses: read_redis_stream
  with:
    connection: cache
    stream_name: emp
    snapshot: false
- uses: add_field
  with:
    fields:
      - field: full_name
        language: jmespath
        expression: concat([fname, ' ' , lname])
- uses: map
  with:
    expression:
      {
        first_name: fname,
        last_name: lname,
        country: UPPER(country_name),
        full_name: full_name,
        greeting: "'Hello ' || CASE WHEN gender = 'F' THEN 'Ms.' WHEN gender = 'M' THEN 'Mr.' ELSE 'N/A' END || ' ' || full_name"
      }
    language: sql
#
# write records to postgres using APPEND load strategy
#
- uses: write_sql
  with:
    connection: hr
    schema: hr
    table: emp
    load_strategy: APPEND